C51 COMPILER V9.01   DS1302                                                                02/07/2019 23:43:19 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN ds1302.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ds1302.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include"ds1302.h"
   2          
   3          //---DS1302дͶȡʱĵַ---//
   4          //---ʱ λдλ;-------//
   5          uchar code READ_RTC_ADDR[7] = {0x81, 0x83, 0x85, 0x87, 0x89, 0x8b, 0x8d}; 
   6          uchar code WRITE_RTC_ADDR[7] = {0x80, 0x82, 0x84, 0x86, 0x88, 0x8a, 0x8c};
   7          
   8          //---洢˳ʱ,洢ʽBCD---//
   9          //DS1302ʱӳʼ201657120000
  10          //uchar TIME[7] = {0, 0, 0x12, 0x07, 0x05, 0x06, 0x16};//0;0;12;07,05,06,year
  11          //DS1302ʱӳʼ2018513230000
  12          //uchar TIME[7] = { 0,0,0x23,0x013,0x05,0x06,0x18 };
  13          //DS1302ʱӳʼ20191180000
  14          uchar TIME[7] = { 0x00,0x00,0x08,0x01,0x01,0x06,0x19 };
  15          
  16          /*******************************************************************************
  17          *            : Ds1302Write
  18          *                  : DS1302ַ+ݣ
  19          *              : addr,dat
  20          *              : 
  21          
  22          DS1302ͨSPI߸Ƭͨŵģһζдʱٵöдֽڣһֽǿֽڣ
             -DS1302ǶдǶRAMǶCLOKĴڶֽھҪдˡ
  23          
  24          ֽڶд
  25                  ֻSCLKΪ͵ƽʱܽCEΪߵƽ
  26                  ڽв֮ǰȽSCLKõ͵ƽȻCEΪߵƽſʼIOҪ͵ĵƽźţȻSCL
             -K
  27                  SCLKʱDS1302дݣSCLK½ʱDS1302ݵIO
  28          
  29          
  30          *******************************************************************************/
  31          
  32          void Ds1302Write(uchar addr, uchar dat)
  33          {
  34   1              uchar n;
  35   1              RST = 0;
  36   1              _nop_();
  37   1      
  38   1              SCLK = 0;//ȽSCLKõ͵ƽ
  39   1              _nop_();
  40   1              RST = 1; //ȻRST(CE)øߵƽ
  41   1              _nop_();
  42   1      
  43   1              for (n=0; n<8; n++)//ʼͰλַ
  44   1              {
  45   2                      DSIO = addr & 0x01;//ݴӵλʼ
  46   2                      addr >>= 1;
  47   2                      SCLK = 1;//ʱDS1302ȡ
  48   2                      _nop_();
  49   2                      SCLK = 0;
  50   2                      _nop_();
  51   2              }
  52   1              for (n=0; n<8; n++)//д8λ
  53   1              {
C51 COMPILER V9.01   DS1302                                                                02/07/2019 23:43:19 PAGE 2   

  54   2                      DSIO = dat & 0x01;
  55   2                      dat >>= 1;
  56   2                      SCLK = 1;//ʱDS1302ȡ
  57   2                      _nop_();
  58   2                      SCLK = 0;
  59   2                      _nop_();        
  60   2              }       
  61   1                       
  62   1              RST = 0;//ݽ
  63   1              _nop_();
  64   1      }
  65          
  66          /*******************************************************************************
  67          *            : Ds1302Read
  68          *                  : ȡһַ
  69          *              : addr
  70          *              : dat
  71          *******************************************************************************/
  72          
  73          uchar Ds1302Read(uchar addr)
  74          {
  75   1              uchar n,dat,dat1;
  76   1              RST = 0;
  77   1              _nop_();
  78   1      
  79   1              SCLK = 0;//ȽSCLKõ͵ƽ
  80   1              _nop_();
  81   1              RST = 1;//ȻRST(CE)øߵƽ
  82   1              _nop_();
  83   1      
  84   1              for(n=0; n<8; n++)//ʼͰλַ
  85   1              {
  86   2                      DSIO = addr & 0x01;//ݴӵλʼ
  87   2                      addr >>= 1;
  88   2                      SCLK = 1;//ʱDS1302ȡ
  89   2                      _nop_();
  90   2                      SCLK = 0;//DS1302½ʱ
  91   2                      _nop_();
  92   2              }
  93   1              _nop_();
  94   1              for(n=0; n<8; n++)//ȡ8λ
  95   1              {
  96   2                      dat1 = DSIO;//λʼ
  97   2                      dat = (dat>>1) | (dat1<<7);
  98   2                      SCLK = 1;
  99   2                      _nop_();
 100   2                      SCLK = 0;//DS1302½ʱ
 101   2                      _nop_();
 102   2              }
 103   1      
 104   1              RST = 0;
 105   1              _nop_();        //ΪDS1302λȶʱ,ġ
 106   1              SCLK = 1;
 107   1              _nop_();
 108   1              DSIO = 0;
 109   1              _nop_();
 110   1              DSIO = 1;
 111   1              _nop_();
 112   1              return dat;     
 113   1      }
 114          
 115          /*******************************************************************************
C51 COMPILER V9.01   DS1302                                                                02/07/2019 23:43:19 PAGE 3   

 116          *            : Ds1302Init
 117          *                  : ʼDS1302.
 118          *              : 
 119          *              : 
 120          *******************************************************************************/
 121          
 122          void Ds1302Init()
 123          {
 124   1              uchar n;
 125   1              Ds1302Write(0x8E,0X00);          //ֹдǹرд
 126   1              for (n=0; n<7; n++)//д7ֽڵʱźţʱ
 127   1              {
 128   2                      Ds1302Write(WRITE_RTC_ADDR[n],TIME[n]); 
 129   2              }
 130   1              Ds1302Write(0x8E,0x80);          //д
 131   1      }
 132          
 133          /*******************************************************************************
 134          *            : Ds1302ReadTime
 135          *                  : ȡʱϢ
 136          *              : 
 137          *              : 
 138          *******************************************************************************/
 139          
 140          void Ds1302ReadTime()
 141          {
 142   1              uchar n;
 143   1              for (n=0; n<7; n++)//ȡ7ֽڵʱźţʱ
 144   1              {
 145   2                      TIME[n] = Ds1302Read(READ_RTC_ADDR[n]);
 146   2              }
 147   1                      
 148   1      }
 149          
 150          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    184    ----
   CONSTANT SIZE    =     14    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
